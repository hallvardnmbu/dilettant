<!doctype html>
<html lang="nb">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Kamerat</title>
        <link rel="stylesheet" href="/stilark.css" />
        <link rel="icon" href="/images/hallvard.jpeg" type="image/jpeg" />
        <style>
            video,
            canvas {
                position: fixed;
                opacity: 0;
                pointer-events: none;
            }
            #ascii {
                font-size: 8px;
                line-height: 0.8;
                letter-spacing: 1px;

                display: inline-flex;
                justify-content: center;
            }
        </style>
    </head>
    <body>
        <header>
            <nav>
                <a href="/meg">Meg</a>
                <a href="/kode">Kode</a>
                <a href="/jobb">Jobb</a>
                <a href="/skole">Skole</a>
            </nav>
        </header>

        <main>
            <video id="v" playsinline autoplay></video>
            <canvas id="c"></canvas>

            <br />

            <pre
                id="ascii"
                onmouseover="border(true)"
                onmouseout="border(false)"
                onclick="location.href = '/'"
            ></pre>
        </main>

        <script>
            const v = document.getElementById("v");
            const c = document.getElementById("c");
            const ascii = document.getElementById("ascii");
            const ctx = c.getContext("2d", { willReadFrequently: true });

            const FPS = 30;
            const W = 120;
            const H = 90;
            c.width = W;
            c.height = H;

            const chars = " ◦◌◯◎◉◍●";
            const size = chars.length - 1;

            navigator.mediaDevices
                .getUserMedia({
                    video: {
                        width: { exact: W },
                        height: { exact: H },
                        frameRate: { max: FPS },
                    },
                })
                .then((stream) => {
                    v.srcObject = stream;
                    v.addEventListener("play", () => {
                        setInterval(() => {
                            ctx.drawImage(v, 0, 0, W, H);
                            const p = ctx.getImageData(0, 0, W, H).data;

                            let image = "";
                            for (let y = 0; y < H; y++) {
                                for (let x = W - 1; x >= 0; x--) {
                                    const i = (y * W + x) * 4;
                                    const brightness =
                                        (p[i] + p[i + 1] + p[i + 2]) / 3;
                                    image +=
                                        chars[
                                            Math.round(
                                                (1 - brightness / 255) * size,
                                            )
                                        ];
                                }
                                image += "\n";
                            }
                            ascii.textContent = image;
                        }, 1000 / FPS);
                    });
                })
                .catch((err) => {});
        </script>

        <script>
            function border(hover) {
                var ascii = document.getElementById("ascii");
                ascii.style["border-color"] = hover
                    ? "var(--hover)"
                    : "var(--link)";
            }
        </script>
    </body>
</html>
