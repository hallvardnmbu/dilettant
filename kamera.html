<!doctype html>
<html lang="nb">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Kamerat</title>
        <link rel="stylesheet" href="/stilark.css" />
        <link rel="icon" href="/images/hallvard.jpeg" type="image/jpeg" />
        <style>
            video,
            canvas {
                position: fixed;
                opacity: 0;
                pointer-events: none;
            }
            #ascii {
                font-size: 12px;
                line-height: 0.8;

                display: inline-flex;
                justify-content: center;
            }
        </style>
    </head>
    <body>
        <header>
            <nav>
                <a href="/meg">Meg</a>
                <a href="/kode">Kode</a>
                <a href="/jobb">Jobb</a>
                <a href="/skole">Skole</a>
            </nav>
        </header>

        <main>
            <video id="v" playsinline autoplay></video>
            <canvas id="c"></canvas>

            <br />

            <pre
                id="ascii"
                onmouseover="border(true)"
                onmouseout="border(false)"
                onclick="location.href = '/'"
            ></pre>
        </main>

        <script>
            const v = document.getElementById("v");
            const c = document.getElementById("c");
            const ascii = document.getElementById("ascii");
            const ctx = c.getContext("2d", { willReadFrequently: true });

            const FPS = 30;
            let W = 120;
            let H = 90;

            function updateDimensions() {
                // Measure character size
                const span = document.createElement("span");
                span.textContent = "X";
                ascii.appendChild(span);
                const rect = span.getBoundingClientRect();
                ascii.removeChild(span);

                const charW = rect.width || 7.2; // approx for 12px font
                const charH = rect.height || 9.6;

                // Calculate available width: 80% of body, max 500px
                const bodyWidth = document.body.clientWidth;
                const targetWidth = Math.min(bodyWidth * 0.8, 500);

                // Calculate W to fill the width
                W = Math.floor(targetWidth / charW);

                // Calculate H to maintain video aspect ratio
                const aspect =
                    v.videoWidth && v.videoHeight
                        ? v.videoWidth / v.videoHeight
                        : 4 / 3;

                // H = W * (1/aspect) * (charW / charH)
                H = Math.floor(W * (1 / aspect) * (charW / charH));

                // Ensure minimum dimensions to avoid invalid canvas size
                W = Math.max(1, W);
                H = Math.max(1, H);

                c.width = W;
                c.height = H;
            }

            window.addEventListener("resize", updateDimensions);

            const chars = " ◦◌◯◎◉◍●";
            const size = chars.length - 1;

            navigator.mediaDevices
                .getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        frameRate: { max: FPS },
                    },
                })
                .then((stream) => {
                    v.srcObject = stream;
                    v.addEventListener("play", () => {
                        updateDimensions();
                        setInterval(() => {
                            if (W <= 0 || H <= 0) return;
                            ctx.drawImage(v, 0, 0, W, H);
                            const p = ctx.getImageData(0, 0, W, H).data;

                            let image = "";
                            for (let y = 0; y < H; y++) {
                                for (let x = W - 1; x >= 0; x--) {
                                    const i = (y * W + x) * 4;
                                    const brightness =
                                        (p[i] + p[i + 1] + p[i + 2]) / 3;
                                    image +=
                                        chars[
                                            Math.round(
                                                (1 - brightness / 255) * size,
                                            )
                                        ];
                                }
                                image += "\n";
                            }
                            ascii.textContent = image;
                        }, 1000 / FPS);
                    });
                })
                .catch((err) => {
                    console.error("Error accessing camera:", err);
                });
        </script>

        <script>
            function border(hover) {
                var ascii = document.getElementById("ascii");
                ascii.style["border-color"] = hover
                    ? "var(--hover)"
                    : "var(--contrast)";
            }
        </script>
    </body>
</html>
